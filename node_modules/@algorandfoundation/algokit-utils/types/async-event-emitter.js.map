{"version":3,"file":"async-event-emitter.js","sources":["../../src/types/async-event-emitter.ts"],"sourcesContent":["import { AVMTracesEventData, TealSourcesDebugEventData } from './debugging'\n\nexport enum EventType {\n  TxnGroupSimulated = 'TxnGroupSimulated',\n  AppCompiled = 'AppCompiled',\n}\n\nexport type EventDataMap = {\n  [EventType.TxnGroupSimulated]: AVMTracesEventData\n  [EventType.AppCompiled]: TealSourcesDebugEventData\n  [key: string]: unknown\n}\n\nexport type AsyncEventListener<T = unknown> = (event: T, eventName: string | symbol) => Promise<void> | void\n\nexport class AsyncEventEmitter {\n  private listenerWrapperMap = new WeakMap<AsyncEventListener, AsyncEventListener>()\n  private listenerMap: Record<string | symbol, AsyncEventListener[]> = {}\n\n  async emitAsync<K extends EventType>(eventName: K, event: EventDataMap[K]): Promise<void>\n  async emitAsync(eventName: string | symbol, event: unknown): Promise<void>\n  async emitAsync(eventName: string | symbol, event: unknown): Promise<void> {\n    for (const listener of this.listenerMap[eventName] ?? []) {\n      await listener(event, eventName)\n    }\n  }\n\n  on<K extends EventType>(eventName: K, listener: AsyncEventListener<EventDataMap[K]>): AsyncEventEmitter\n  on<T = unknown>(eventName: string | symbol, listener: AsyncEventListener<T>): AsyncEventEmitter\n  on(eventName: string | symbol, listener: AsyncEventListener): AsyncEventEmitter {\n    if (!this.listenerMap[eventName]) this.listenerMap[eventName] = []\n    this.listenerMap[eventName].push(listener as AsyncEventListener)\n    return this\n  }\n\n  once<K extends EventType>(eventName: K, listener: AsyncEventListener<EventDataMap[K]>): AsyncEventEmitter\n  once<T = unknown>(eventName: string | symbol, listener: AsyncEventListener<T>): AsyncEventEmitter\n  once(eventName: string | symbol, listener: AsyncEventListener): AsyncEventEmitter {\n    const wrappedListener: AsyncEventListener = async (event, eventName) => {\n      try {\n        return await listener(event, eventName)\n      } finally {\n        this.removeListener(eventName, wrappedListener)\n      }\n    }\n    this.listenerWrapperMap.set(listener, wrappedListener)\n    return this.on(eventName, wrappedListener)\n  }\n\n  removeListener(eventName: string | symbol, listener: AsyncEventListener): AsyncEventEmitter {\n    const wrappedListener = this.listenerWrapperMap.get(listener)\n    if (wrappedListener) {\n      this.listenerWrapperMap.delete(listener)\n      if (this.listenerMap[eventName]?.indexOf(wrappedListener) !== -1) {\n        this.listenerMap[eventName].splice(this.listenerMap[eventName].indexOf(wrappedListener), 1)\n      }\n    } else {\n      if (this.listenerMap[eventName]?.indexOf(listener) !== -1) {\n        this.listenerMap[eventName].splice(this.listenerMap[eventName].indexOf(listener), 1)\n      }\n    }\n\n    return this\n  }\n\n  off = this.removeListener\n}\n"],"names":["EventType"],"mappings":";;AAEYA,2BAGX;AAHD,CAAA,UAAY,SAAS,EAAA;AACnB,IAAA,SAAA,CAAA,mBAAA,CAAA,GAAA,mBAAuC,CAAA;AACvC,IAAA,SAAA,CAAA,aAAA,CAAA,GAAA,aAA2B,CAAA;AAC7B,CAAC,EAHWA,iBAAS,KAATA,iBAAS,GAGpB,EAAA,CAAA,CAAA,CAAA;MAUY,iBAAiB,CAAA;AAA9B,IAAA,WAAA,GAAA;AACU,QAAA,IAAA,CAAA,kBAAkB,GAAG,IAAI,OAAO,EAA0C,CAAA;QAC1E,IAAW,CAAA,WAAA,GAAkD,EAAE,CAAA;AAgDvE,QAAA,IAAA,CAAA,GAAG,GAAG,IAAI,CAAC,cAAc,CAAA;KAC1B;AA7CC,IAAA,MAAM,SAAS,CAAC,SAA0B,EAAE,KAAc,EAAA;AACxD,QAAA,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,IAAI,EAAE,EAAE;AACxD,YAAA,MAAM,QAAQ,CAAC,KAAK,EAAE,SAAS,CAAC,CAAA;SACjC;KACF;IAID,EAAE,CAAC,SAA0B,EAAE,QAA4B,EAAA;AACzD,QAAA,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC;AAAE,YAAA,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,GAAG,EAAE,CAAA;QAClE,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,QAA8B,CAAC,CAAA;AAChE,QAAA,OAAO,IAAI,CAAA;KACZ;IAID,IAAI,CAAC,SAA0B,EAAE,QAA4B,EAAA;QAC3D,MAAM,eAAe,GAAuB,OAAO,KAAK,EAAE,SAAS,KAAI;AACrE,YAAA,IAAI;AACF,gBAAA,OAAO,MAAM,QAAQ,CAAC,KAAK,EAAE,SAAS,CAAC,CAAA;aACxC;oBAAS;AACR,gBAAA,IAAI,CAAC,cAAc,CAAC,SAAS,EAAE,eAAe,CAAC,CAAA;aAChD;AACH,SAAC,CAAA;QACD,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,EAAE,eAAe,CAAC,CAAA;QACtD,OAAO,IAAI,CAAC,EAAE,CAAC,SAAS,EAAE,eAAe,CAAC,CAAA;KAC3C;IAED,cAAc,CAAC,SAA0B,EAAE,QAA4B,EAAA;QACrE,MAAM,eAAe,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;QAC7D,IAAI,eAAe,EAAE;AACnB,YAAA,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAA;AACxC,YAAA,IAAI,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,EAAE,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC,EAAE;gBAChE,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,OAAO,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC,CAAA;aAC5F;SACF;aAAM;AACL,YAAA,IAAI,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,EAAE,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE;gBACzD,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAA;aACrF;SACF;AAED,QAAA,OAAO,IAAI,CAAA;KACZ;AAGF;;;;"}